---
// Component for transfer calculator UI with API integration
import 'flag-icons/css/flag-icons.min.css';
import ChevronDownIcon from '@assets/uae/chevron-down 1.svg';
import InfoIcon from '@assets/uae/info.svg';
import QRModalTriggerer from '@components/common/QRModalTriggerer.astro';

const {
  translations: { transferCalculator = {} },
  lang,
} = Astro.locals;

// Types for API
type Payment = { amount: number; currency: string };
type Transaction = Payment & { country_code: string };

type Quotation = {
  id: string;
  provider: string;
  transfer_type: string;
  transfer_fx_rate: number;
  fee: Payment;
  expire_at: Date;
  best_offer: boolean;
  receive: Transaction;
  operation: string;
  transfer_channel_name: string;
};

type RemittanceExchangeResponse = {
  id: string;
  quotation_mode: 'SEND_AMOUNT';
  send: Transaction;
  receive: Transaction;
  user_saves: Payment;
  last_updated: string;
  expired_at: string;
  fee: Payment;
  quotations: Quotation[];
};

type ExchangeRequest = {
  quotation_mode: 'SEND_AMOUNT';
  receive: {
    country_code: string;
    currency: string;
  };
  send: Transaction;
};
---

<div class='p-4 bg-gray-100 shadow-lg md:p-6 rounded-2xl w-full max-w-[484px]' id='transfer-calculator'>
  <!-- You send section -->
  <div class='mb-4 md:mb-6'>
    <label class="text-black text-sm font-normal font-['Hero_New'] leading-tight block mb-2 text-start">
      {transferCalculator.labels.youSend}
    </label>
    <div class='relative'>
      <input
        type='number'
        value='1000'
        id='send-amount'
        min='1'
        max='500000'
        step='0.01'
        class={`border-stone-300 bg-white w-full text-black text-lg md:text-xl font-normal font-['Hero_New'] leading-relaxed border rounded-lg px-3 py-3 md:py-4 pr-16 md:pr-20 focus:outline-none focus:ring-2 focus:ring-black ${lang === 'ar' ? 'text-end' : 'text-start'}`}
        aria-describedby='send-amount-error'
      />
      <div class='absolute flex items-center gap-1 transform -translate-y-1/2 md:gap-2 right-2 md:right-3 top-1/2'>
        <span class='text-lg font-normal rounded-full fi fi-ae fis md:text-xl'></span>
        <span class="text-black text-lg md:text-xl font-normal font-['Hero_New'] leading-relaxed">AED</span>
        <ChevronDownIcon class='w-4 h-4 opacity-0' />
      </div>
      <!-- Error tooltip -->
      <div
        id='send-amount-error'
        class='absolute left-0 z-10 invisible mt-1 transition-all duration-200 opacity-0 pointer-events-none top-full'
      >
        <div class='px-2 py-1 text-xs text-white bg-red-600 rounded shadow-lg whitespace-nowrap'>
          <div class='absolute w-2 h-2 transform rotate-45 bg-red-600 -top-1 left-3'></div>
          <span id='send-amount-error-text'></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Recipient receives section -->
  <div class='mb-4 md:mb-6'>
    <label class="text-black text-sm font-normal font-['Hero_New'] leading-tight block mb-2 text-start">
      {transferCalculator.labels.recipientReceives}
    </label>
    <div class='relative'>
      <input
        type='number'
        value='270'
        id='receive-amount'
        readonly
        class={`border-stone-300 bg-white w-full text-black text-lg md:text-xl font-normal font-['Hero_New'] leading-relaxed border rounded-lg px-3 py-3 md:py-4 pr-20 md:pr-24 focus:outline-none focus:ring-2 focus:ring-black ${lang === 'ar' ? 'text-end' : 'text-start'}`}
      />
      <div class='absolute flex items-center gap-1 transform -translate-y-1/2 right-2 md:right-3 top-1/2'>
        <div class='relative currency-selector'>
          <button
            id='currency-button'
            type='button'
            class="bg-transparent border-none outline-none text-black text-lg md:text-xl font-normal font-['Hero_New'] leading-relaxed cursor-pointer flex items-center gap-1 pr-1 hover:text-[#794eff] transition-colors duration-200"
            aria-describedby='currency-error'
          >
            <span id='selected-currency-display'>ðŸ‡ºðŸ‡¸ USD</span>
            <ChevronDownIcon class='w-4 h-4' />
          </button>
          <div
            id='currency-dropdown'
            class='hidden max-h-[180px] overflow-y-auto absolute right-0 z-20 mt-2 min-w-[120px] bg-white rounded-lg border border-gray-200 shadow-xl p-1.5 origin-top-right focus:outline-none transform transition-all duration-200 dropdown-menu'
          >
            <div class='py-1' role='menu' aria-orientation='vertical' aria-labelledby='currency-button'>
              <button
                type='button'
                class='w-full flex items-center px-3 py-2 text-sm font-medium rounded-md transition-all duration-200 ease-in-out hover:bg-[#794eff25] hover:text-[#794eff] text-left text-gray-700'
                data-currency='USD'
                data-flag='ðŸ‡ºðŸ‡¸'
                role='menuitem'
              >
                <span class='flex-grow'>ðŸ‡ºðŸ‡¸ USD</span>
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Error tooltip -->
      <div
        id='currency-error'
        class='absolute left-0 z-10 invisible mt-1 transition-all duration-200 opacity-0 pointer-events-none top-full'
      >
        <div class='px-2 py-1 text-xs text-white bg-red-600 rounded shadow-lg whitespace-nowrap'>
          <div class='absolute w-2 h-2 transform rotate-45 bg-red-600 -top-1 left-3'></div>
          <span id='currency-error-text'></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Transfer details -->
  <div class='mb-4 space-y-2 md:mb-6 md:space-y-3'>
    <!-- Transfer fee -->
    <div class='flex items-center justify-between'>
      <span class="text-black text-xs md:text-sm font-normal font-['Hero_New'] leading-tight">
        {transferCalculator.labels.transferFee}:
      </span>
      <span class="text-black text-xs md:text-sm font-normal font-['Hero_New'] leading-tight" id='transfer-fee'>
        0.000 AED
      </span>
    </div>

    <!-- Exchange rate -->
    <div class='flex items-center justify-between'>
      <span class="text-black text-xs md:text-sm font-normal font-['Hero_New'] leading-tight flex-shrink-0">
        {transferCalculator.labels.exchangeRate}
      </span>
      <div class='flex items-center gap-2 text-right'>
        <span class="text-black text-xs md:text-sm font-normal font-['Hero_New'] leading-tight" id='exchange-rate'>
          1.00 AED = 0.27 USD
        </span>
        <InfoIcon class='w-4 h-4' />
      </div>
    </div>
  </div>

  <!-- Send money button -->
  <QRModalTriggerer>
    <button
      id='send-money-btn'
      class="w-full bg-black text-white text-base md:text-lg font-medium font-['Hero_New'] leading-normal py-3 md:py-4 rounded-lg hover:bg-gray-800 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed"
    >
      <span id='btn-text'>{transferCalculator.button.sendNow}</span>
      <span id='btn-loading' class='hidden'>{transferCalculator.button.processing}</span>
    </button>
  </QRModalTriggerer>
</div>

<script define:vars={{ transferCalculator }}>
  // Define locale strings for client-side script
  // We need to define these separately from the component import because client scripts are processed differently
  const locale = { errors: transferCalculator.errors };

  // API integration for real-time exchange rates
  const API_URL = 'https://api.jinglepay.dev/api/v0/remittance/rates-review/';
  const COUNTRIES_API_URL = 'https://api.jinglepay.dev/api/v0/remittance/countries/';

  let debounceTimer: ReturnType<typeof setTimeout> | undefined;
  let availableCountries: Countries = {};
  let isValidating = false;

  // Validation constants
  const VALIDATION_RULES = {
    MIN_AMOUNT: 1,
    MAX_AMOUNT: 500000,
    DEBOUNCE_DELAY: 500,
  };

  // Types for countries API
  type CountryInfo = { code: string; currency: string; iso2_code: string; name: string; unicode: string };
  type Countries = { [key: string]: CountryInfo };

  // Validation error types
  type ValidationError = {
    field: string;
    message: string;
    code: string;
  };

  // Validation functions
  function validateSendAmount(amount: string): ValidationError | null {
    if (!amount || amount.trim() === '') {
      return { field: 'send-amount', message: locale.errors.requiredAmount, code: 'REQUIRED' };
    }

    const numAmount = parseFloat(amount);
    if (isNaN(numAmount)) {
      return { field: 'send-amount', message: locale.errors.invalidNumber, code: 'INVALID_NUMBER' };
    }

    if (numAmount < VALIDATION_RULES.MIN_AMOUNT) {
      return {
        field: 'send-amount',
        message: locale.errors.minAmount.replace('{{min}}', VALIDATION_RULES.MIN_AMOUNT.toString()),
        code: 'MIN_AMOUNT',
      };
    }

    if (numAmount > VALIDATION_RULES.MAX_AMOUNT) {
      return {
        field: 'send-amount',
        message: locale.errors.maxAmount.replace('{{max}}', VALIDATION_RULES.MAX_AMOUNT.toLocaleString()),
        code: 'MAX_AMOUNT',
      };
    }

    return null;
  }

  function validateCurrency(currency: string): ValidationError | null {
    if (!currency || currency.trim() === '') {
      return { field: 'receive-currency-select', message: locale.errors.requiredCurrency, code: 'REQUIRED' };
    }

    // Check if currency is supported
    if (!availableCountries || Object.keys(availableCountries).length === 0) {
      return { field: 'receive-currency-select', message: locale.errors.dataUnavailable, code: 'DATA_UNAVAILABLE' };
    }

    return null;
  }

  function validateApiResponse(data: any): ValidationError | null {
    if (!data) {
      return { field: 'api', message: locale.errors.noResponse, code: 'NO_RESPONSE' };
    }

    if (!data.receive || typeof data.receive.amount !== 'number') {
      return { field: 'api', message: locale.errors.invalidResponse, code: 'INVALID_RESPONSE' };
    }

    if (!data.quotations || !Array.isArray(data.quotations) || data.quotations.length === 0) {
      return { field: 'api', message: locale.errors.noQuotations, code: 'NO_QUOTATIONS' };
    }

    return null;
  }

  function showError(error: ValidationError) {
    const fieldError = document.getElementById(`${error.field}-error`);
    const fieldErrorText = document.getElementById(`${error.field}-error-text`);
    const sendButton = document.getElementById('send-money-btn') as HTMLButtonElement;

    // Show field-specific error tooltip
    if (fieldError && fieldErrorText) {
      fieldErrorText.textContent = error.message;
      fieldError.classList.remove('opacity-0', 'invisible');
      fieldError.classList.add('opacity-100', 'visible');
    }

    // Add error styling to input
    const inputElement = document.getElementById(error.field) as HTMLInputElement;
    if (inputElement) {
      inputElement.classList.add('border-red-500', 'focus:ring-red-500');
      inputElement.classList.remove('border-stone-300', 'focus:ring-black');
    }

    // Disable send button
    if (sendButton) {
      sendButton.disabled = true;
    }
  }

  function clearErrors() {
    const sendButton = document.getElementById('send-money-btn') as HTMLButtonElement;

    // Clear all field error tooltips
    const errorFields = ['send-amount-error', 'currency-error'];
    errorFields.forEach((fieldId) => {
      const fieldError = document.getElementById(fieldId);
      const fieldErrorText = document.getElementById(`${fieldId}-text`);
      if (fieldError && fieldErrorText) {
        fieldError.classList.add('opacity-0', 'invisible');
        fieldError.classList.remove('opacity-100', 'visible');
        fieldErrorText.textContent = '';
      }
    });

    // Remove error styling from inputs
    const inputs = ['send-amount', 'receive-currency-select'];
    inputs.forEach((inputId) => {
      const inputElement = document.getElementById(inputId) as HTMLInputElement;
      if (inputElement) {
        inputElement.classList.remove('border-red-500', 'focus:ring-red-500');
        inputElement.classList.add('border-stone-300', 'focus:ring-black');
      }
    });

    // Enable send button
    if (sendButton) {
      sendButton.disabled = false;
    }
  }

  function showLoading(show: boolean) {
    const btnText = document.getElementById('btn-text');
    const btnLoading = document.getElementById('btn-loading');
    const sendButton = document.getElementById('send-money-btn') as HTMLButtonElement;

    if (btnText && btnLoading && sendButton) {
      if (show) {
        btnText.classList.add('hidden');
        btnLoading.classList.remove('hidden');
        sendButton.disabled = true;
      } else {
        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
        sendButton.disabled = false;
      }
    }
  }

  // Mock countries data for fallback
  const MOCK_COUNTRIES: Countries = {
    US: {
      code: 'US',
      currency: 'USD',
      iso2_code: 'US',
      name: 'United States',
      unicode: 'ðŸ‡ºðŸ‡¸',
    },
    GB: {
      code: 'GB',
      currency: 'GBP',
      iso2_code: 'GB',
      name: 'United Kingdom',
      unicode: 'ðŸ‡¬ðŸ‡§',
    },
    EU: {
      code: 'EU',
      currency: 'EUR',
      iso2_code: 'EU',
      name: 'European Union',
      unicode: 'ðŸ‡ªðŸ‡º',
    },
    CA: {
      code: 'CA',
      currency: 'CAD',
      iso2_code: 'CA',
      name: 'Canada',
      unicode: 'ðŸ‡¨ðŸ‡¦',
    },
    AU: {
      code: 'AU',
      currency: 'AUD',
      iso2_code: 'AU',
      name: 'Australia',
      unicode: 'ðŸ‡¦ðŸ‡º',
    },
    IN: {
      code: 'IN',
      currency: 'INR',
      iso2_code: 'IN',
      name: 'India',
      unicode: 'ðŸ‡®ðŸ‡³',
    },
    PK: {
      code: 'PK',
      currency: 'PKR',
      iso2_code: 'PK',
      name: 'Pakistan',
      unicode: 'ðŸ‡µðŸ‡°',
    },
    BD: {
      code: 'BD',
      currency: 'BDT',
      iso2_code: 'BD',
      name: 'Bangladesh',
      unicode: 'ðŸ‡§ðŸ‡©',
    },
    PH: {
      code: 'PH',
      currency: 'PHP',
      iso2_code: 'PH',
      name: 'Philippines',
      unicode: 'ðŸ‡µðŸ‡­',
    },
    EG: {
      code: 'EG',
      currency: 'EGP',
      iso2_code: 'EG',
      name: 'Egypt',
      unicode: 'ðŸ‡ªðŸ‡¬',
    },
  };

  // Fetch available countries for the dropdown
  async function fetchCountries() {
    try {
      const response = await fetch(COUNTRIES_API_URL);
      if (!response.ok) {
        throw new Error(`Countries API error: ${response.status}`);
      }
      const data = await response.json();

      // Validate countries data
      if (!data || typeof data !== 'object') {
        throw new Error('Invalid countries data format');
      }

      availableCountries = data;
      populateCountryDropdown(data);
    } catch (error) {
      console.error('Failed to fetch countries:', error);
      // Use mock data if API fails
      console.log('Using mock countries data as fallback');
      availableCountries = MOCK_COUNTRIES;
      populateCountryDropdown(MOCK_COUNTRIES);
    }
  }

  // Populate the country dropdown with fetched data
  function populateCountryDropdown(countries: Countries) {
    const dropdownMenu = document.querySelector('#currency-dropdown .py-1');
    if (!dropdownMenu || !countries || typeof countries !== 'object') return;

    // Clear existing options
    dropdownMenu.innerHTML = '';

    // Iterate through countries object
    Object.values(countries).forEach((country: CountryInfo) => {
      const currency = country.currency;
      const countryName = country.name;
      const countryCode = country.iso2_code || country.code;

      if (currency) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className =
          'w-full flex items-center px-3 py-2 text-sm font-medium rounded-md transition-all duration-200 ease-in-out hover:bg-[#794eff25] hover:text-[#794eff] text-left text-gray-700';
        button.setAttribute('data-currency', currency);
        button.setAttribute('data-country-code', countryCode);
        button.setAttribute('data-country-name', countryName);
        button.setAttribute('role', 'menuitem');

        // Create flag icon using flag-icons
        const flagIcon = createFlagIcon(countryCode);
        button.appendChild(flagIcon);

        const span = document.createElement('span');
        span.className = 'flex-grow';
        span.textContent = currency;
        button.appendChild(span);

        dropdownMenu.appendChild(button);
      }
    });

    // Re-initialize dropdown event listeners for new options
    initializeCurrencyDropdownOptions();

    // Set USD as default if available
    const usdButton = dropdownMenu.querySelector('button[data-currency="USD"]');
    if (usdButton) {
      selectedCurrency = 'USD';

      // Update display with flag icon
      const displayEl = document.getElementById('selected-currency-display');
      if (displayEl) {
        // Clear existing content
        displayEl.innerHTML = '';

        // Add flag icon
        const flagIcon = createFlagIcon('US');
        displayEl.appendChild(flagIcon);

        // Add currency text
        const currencyText = document.createElement('span');
        currencyText.textContent = 'USD';
        displayEl.appendChild(currencyText);
      }

      // Mark as selected
      usdButton.classList.add('selected');
    }
  }

  // Helper function to get flag icon class from country code using flag-icons library
  function getFlagIconClass(countryCode: string): string {
    if (!countryCode || countryCode.length !== 2) return 'fi fi-xx rounded-full'; // Default flag for unknown countries

    // Convert country code to lowercase for flag-icons CSS classes
    const code = countryCode.toLowerCase();

    // Map some special cases that might have different codes
    const codeMap: { [key: string]: string } = {
      eu: 'eu', // European Union
      gb: 'gb', // Great Britain
      uk: 'gb', // UK -> GB mapping
    };

    const finalCode = codeMap[code] || code;
    return `fi fi-${finalCode} rounded-full`;
  }

  // Helper function to create flag icon element
  function createFlagIcon(countryCode: string): HTMLSpanElement {
    const flagClass = getFlagIconClass(countryCode);
    const flagElement = document.createElement('span');
    flagElement.className = `${flagClass} fis inline-block w-5 h-5 mr-2`;
    return flagElement;
  }

  // Encryption utility - inline implementation for client-side use
  async function encryptRequest(data: any): Promise<string> {
    try {
      // Import jose dynamically for client-side use
      const { CompactEncrypt, importJWK } = await import('jose');

      const PUBLIC_KEY_CONFIG = {
        kty: 'RSA',
        e: 'AQAB',
        n: 'jiIRvCBjTToaYMHTUxnKoTdKGHdtuymLWl-s3oeiZ9tWXqMeOdbiCYMSzC-N8kkpu5sdmknkVROeKKVS3OvmyxBuZ6hDfwAyfdg0t8273JX6Z7fZH6tL7T2HHJ4ItQesTuhPmJR5_oGiPO5mDjC5SUd5otrbKqUAAy9fLtT5_l91uUc27bZGvkL9Tzi9EHNeA_LgnYRNohOygirKx1G-hdGVWoisVIdiIY7Hc_XaViCCNwhiEELN4iS4MOD4Suut7Y6V5l_PmSCnUcn6-R194edIKHd7TiiFQrkNab2gb16Qdu8fCO41OdRlF_ifvWWxtqHeW3eqRdDYwaBxDvlsnQ',
      };

      const rsaPublicKey = await importJWK(PUBLIC_KEY_CONFIG, 'RSA-OAEP-256');
      const encryptedData = await new CompactEncrypt(new TextEncoder().encode(JSON.stringify(data)))
        .setProtectedHeader({
          alg: 'RSA-OAEP-256',
          enc: 'A256CBC-HS512',
          typ: 'JWE',
        })
        .encrypt(rsaPublicKey);

      return encryptedData;
    } catch (error) {
      console.error('Encryption error:', error);
      throw error;
    }
  }

  async function fetchExchangeRate(sendAmount: string): Promise<any> {
    try {
      // Validate input before making API call
      const amountError = validateSendAmount(sendAmount);
      if (amountError) {
        throw new Error(amountError.message);
      }

      // Get selected currency from dropdown
      const currencySelect = document.getElementById('receive-currency-select') as HTMLSelectElement;
      if (!currencySelect) {
        throw new Error('Currency selector not found');
      }

      const selectedCurrency = currencySelect.value;
      const currencyError = validateCurrency(selectedCurrency);
      if (currencyError) {
        throw new Error(currencyError.message);
      }

      // Find country code for selected currency
      let countryCode = 'US'; // default
      for (const [code, country] of Object.entries(availableCountries)) {
        const countryInfo = country as CountryInfo;
        if (countryInfo.currency === selectedCurrency) {
          countryCode = countryInfo.iso2_code || code;
          break;
        }
      }

      const sendAmountNum = parseFloat(sendAmount);
      const requestData = {
        quotation_mode: 'SEND_AMOUNT',
        receive: {
          country_code: countryCode,
          currency: selectedCurrency,
        },
        send: {
          amount: sendAmountNum,
          currency: 'AED',
          country_code: 'AE',
        },
      };

      const encryptedPayload = await encryptRequest(requestData);

      const response = await fetch(API_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'text/plain',
        },
        body: encryptedPayload,
      });

      if (!response.ok) {
        throw new Error(`Server error: ${response.status} - ${response.statusText}`);
      }

      const data = await response.json();

      // Validate API response
      const responseError = validateApiResponse(data);
      if (responseError) {
        throw new Error(responseError.message);
      }

      return data;
    } catch (error) {
      console.error('Error fetching exchange rate:', error);
      // Return proper mock data matching RemittanceExchangeResponse type
      const sendAmountNum = parseFloat(sendAmount) || 1000;

      // Get selected currency and country from dropdown
      const currencySelect = document.getElementById('receive-currency-select') as HTMLSelectElement;
      const selectedCurrency = currencySelect?.value || 'USD';
      const selectedOption = currencySelect?.selectedOptions[0];
      const countryCode = selectedOption?.dataset.countryCode || 'US';

      // Mock exchange rates for different currencies
      const mockRates: { [key: string]: number } = {
        USD: 0.27,
        GBP: 0.21,
        EUR: 0.25,
        CAD: 0.37,
        AUD: 0.41,
        INR: 22.75,
        PKR: 75.5,
        BDT: 29.15,
        PHP: 15.25,
        EGP: 13.45,
      };

      const exchangeRate = mockRates[selectedCurrency] || 0.27;
      const receiveAmountNum = sendAmountNum * exchangeRate;

      return {
        id: 'mock-quote-' + Date.now(),
        quotation_mode: 'SEND_AMOUNT',
        send: {
          amount: sendAmountNum,
          currency: 'AED',
          country_code: 'AE',
        },
        receive: {
          amount: receiveAmountNum,
          currency: selectedCurrency,
          country_code: countryCode,
        },
        user_saves: {
          amount: 0,
          currency: 'AED',
        },
        last_updated: new Date().toISOString(),
        expired_at: new Date(Date.now() + 300000).toISOString(), // 5 minutes from now
        fee: {
          amount: 0,
          currency: 'AED',
        },
        quotations: [
          {
            id: 'mock-quotation-' + Date.now(),
            provider: 'Mock Provider',
            transfer_type: 'BANK_TRANSFER',
            transfer_fx_rate: exchangeRate,
            fee: {
              amount: 0,
              currency: 'AED',
            },
            expire_at: new Date(Date.now() + 300000),
            best_offer: true,
            receive: {
              amount: receiveAmountNum,
              currency: selectedCurrency,
              country_code: countryCode,
            },
            operation: 'ENCRYPT',
            transfer_channel_name: 'Standard Transfer',
          },
        ],
      };
    }
  }

  function updateCalculator(data: any) {
    const receiveAmountEl = document.getElementById('receive-amount') as HTMLInputElement;
    const transferFeeEl = document.getElementById('transfer-fee');
    const exchangeRateEl = document.getElementById('exchange-rate');

    if (receiveAmountEl && data.receive) {
      receiveAmountEl.value = data.receive.amount.toFixed(2);
    }

    if (transferFeeEl && data.fee) {
      transferFeeEl.textContent = `${data.fee.amount.toFixed(3)} ${data.fee.currency || 'AED'}`;
    }

    if (exchangeRateEl && data.quotations && data.quotations.length > 0) {
      const rate = data.quotations[0].transfer_fx_rate;
      const currencySelect = document.getElementById('receive-currency-select') as HTMLSelectElement;
      const selectedCurrency = currencySelect?.value || 'USD';
      exchangeRateEl.textContent = `1.00 AED = ${rate.toFixed(2)} ${selectedCurrency}`;
    }
  }

  function handleAmountChange() {
    const sendAmountEl = document.getElementById('send-amount') as HTMLInputElement;
    const amount = sendAmountEl?.value || '1000';

    // Clear previous errors
    clearErrors();

    // Validate amount immediately for user feedback
    const amountError = validateSendAmount(amount);
    if (amountError) {
      showError(amountError);
      return;
    }

    // Prevent multiple simultaneous validations
    if (isValidating) {
      return;
    }

    // Debounce API calls
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      try {
        isValidating = true;
        showLoading(true);
        const data = await fetchExchangeRate(amount);
        updateCalculator(data);
        clearErrors(); // Clear any previous errors on success
      } catch (error) {
        console.error('Exchange rate fetch error:', error);
        showError({
          field: 'api',
          message: error instanceof Error ? error.message : 'Failed to get exchange rate',
          code: 'API_ERROR',
        });
      } finally {
        isValidating = false;
        showLoading(false);
      }
    }, VALIDATION_RULES.DEBOUNCE_DELAY);
  }

  // Currency dropdown functionality
  let selectedCurrency = 'USD';

  // Initialize event listeners for currency dropdown options
  function initializeCurrencyDropdownOptions() {
    const currencyOptions = document.querySelectorAll('[data-currency]');
    const currencyDropdown = document.getElementById('currency-dropdown');

    // Handle currency selection
    function selectCurrency(currency: string, countryCode: string) {
      selectedCurrency = currency;

      // Update display with flag icon
      const displayEl = document.getElementById('selected-currency-display');
      if (displayEl) {
        // Clear existing content
        displayEl.innerHTML = '';

        // Add flag icon
        const flagIcon = createFlagIcon(countryCode);
        displayEl.appendChild(flagIcon);

        // Add currency text
        const currencyText = document.createElement('span');
        currencyText.textContent = currency;
        displayEl.appendChild(currencyText);
      }

      // Update selected state in dropdown
      currencyOptions.forEach((option) => {
        option.classList.remove('selected');
        if (option.getAttribute('data-currency') === currency) {
          option.classList.add('selected');
        }
      });

      // Close dropdown
      currencyDropdown?.classList.add('hidden');

      // Trigger currency change handler
      handleCurrencyChange();
    }

    // Add click listeners to all currency options
    currencyOptions.forEach((option) => {
      // Remove any existing listeners to avoid duplicates
      const newOption = option.cloneNode(true) as Element;
      option.parentNode?.replaceChild(newOption, option);

      newOption.addEventListener('click', (e) => {
        e.preventDefault();
        const currency = newOption.getAttribute('data-currency') || 'USD';
        const countryCode = newOption.getAttribute('data-country-code') || 'US';
        selectCurrency(currency, countryCode);
      });
    });
  }

  function initializeCurrencyDropdown() {
    const currencyButton = document.getElementById('currency-button');
    const currencyDropdown = document.getElementById('currency-dropdown');

    // Toggle dropdown
    function toggleCurrencyDropdown(e: Event) {
      e.stopPropagation();
      e.preventDefault();
      currencyDropdown?.classList.toggle('hidden');
    }

    // Add event listeners
    if (currencyButton) {
      currencyButton.addEventListener('click', toggleCurrencyDropdown);
      currencyButton.addEventListener('touchend', toggleCurrencyDropdown);
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const target = e.target as Element;
      if (!target.closest('.currency-selector')) {
        currencyDropdown?.classList.add('hidden');
      }
    });

    // Initialize options if they exist
    initializeCurrencyDropdownOptions();
  }

  // Updated handleCurrencyChange to work with custom dropdown
  function handleCurrencyChange() {
    const sendAmountEl = document.getElementById('send-amount') as HTMLInputElement;
    const amount = sendAmountEl?.value || '1000';
    const currency = selectedCurrency;

    // Clear previous errors
    clearErrors();

    // Validate currency selection
    const currencyError = validateCurrency(currency);
    if (currencyError) {
      showError(currencyError);
      return;
    }

    // Validate amount as well
    const amountError = validateSendAmount(amount);
    if (amountError) {
      showError(amountError);
      return;
    }

    // Prevent multiple simultaneous validations
    if (isValidating) {
      return;
    }

    // Update exchange rate when currency changes
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      try {
        isValidating = true;
        showLoading(true);
        const data = await fetchExchangeRate(amount);
        updateCalculator(data);
        clearErrors(); // Clear any previous errors on success
      } catch (error) {
        console.error('Exchange rate fetch error:', error);
        showError({
          field: 'api',
          message: error instanceof Error ? error.message : 'Failed to get exchange rate',
          code: 'API_ERROR',
        });
      } finally {
        isValidating = false;
        showLoading(false);
      }
    }, 300);
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    // Fetch available countries
    fetchCountries();

    // Initialize currency dropdown
    initializeCurrencyDropdown();

    const sendAmountEl = document.getElementById('send-amount');

    if (sendAmountEl) {
      sendAmountEl.addEventListener('input', handleAmountChange);

      // Add blur validation for immediate feedback
      sendAmountEl.addEventListener('blur', () => {
        const amount = (sendAmountEl as HTMLInputElement).value;
        const amountError = validateSendAmount(amount);
        if (amountError) {
          showError(amountError);
        } else {
          clearErrors();
        }
      });

      // Prevent invalid characters
      sendAmountEl.addEventListener('keypress', (e) => {
        const char = String.fromCharCode(e.which);
        if (!/[0-9.]/.test(char) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) {
          e.preventDefault();
        }
      });
    }

    // Initial load with validation
    setTimeout(() => {
      handleAmountChange();
    }, 100); // Small delay to ensure DOM is fully ready
  });

  // Add validation on form submission (if integrated with a form)
  function validateForm(): boolean {
    const sendAmountEl = document.getElementById('send-amount') as HTMLInputElement;

    const amount = sendAmountEl?.value || '';
    const currency = selectedCurrency || '';

    const amountError = validateSendAmount(amount);
    const currencyError = validateCurrency(currency);

    if (amountError) {
      showError(amountError);
      return false;
    }

    if (currencyError) {
      showError(currencyError);
      return false;
    }

    clearErrors();
    return true;
  }

  // Expose validation function globally for potential external use
  (window as any).transferCalculatorValidation = {
    validateForm,
    validateSendAmount,
    validateCurrency,
    clearErrors,
    showError,
  };

  // Set correct store URL for download link inside mobile menu
  const downloadLink = document.getElementById('send-money-btn') as HTMLButtonElement | null;
  if (downloadLink) {
    const ua = navigator.userAgent;
    const isIOS = /iPhone|iPad|iPod/i.test(ua);
    downloadLink.onclick = () => {
      if (isIOS) {
        window.open('https://apps.apple.com/pl/app/jingle-pay/id1493392189', '_blank');
      } else {
        window.open('https://play.google.com/store/apps/details?id=com.jinglepay&hl=en', '_blank');
      }
    };
  }
</script>

<style>
  /* Hide spinner controls for number inputs */
  input[type='number']::-webkit-outer-spin-button,
  input[type='number']::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }

  /* Firefox */
  input[type='number'] {
    -moz-appearance: textfield;
  }

  /* Currency selector dropdown styling */
  .currency-selector {
    position: relative;
  }

  /* Animation for dropdown */
  #currency-dropdown:not(.hidden) {
    animation: dropdown-open 0.2s ease-out forwards;
  }

  @keyframes dropdown-open {
    0% {
      opacity: 0;
      transform: translateY(-5px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Add hover effects to dropdown items */
  .currency-selector .dropdown-menu button:hover {
    background-color: rgba(121, 78, 255, 0.1);
    color: #794eff;
  }

  /* Selected state styling */
  .currency-selector .dropdown-menu button.selected {
    background-color: rgba(121, 78, 255, 0.3);
    color: #794eff;
    font-weight: 600;
  }
</style>
