---
import { Image } from 'astro:assets';
import pakFlag from '@assets/flags/pak.svg';

interface Props {
  onSubmit?: string;
  class?: string;
  smsText?: string;
}

const {
  onSubmit = '#',
  class: className = '',
  smsText = 'Download JinglePay now: https://jinglepay.com/download',
} = Astro.props;
---

<div class={`flex w-full max-w-xs rounded-md overflow-hidden shadow-md ${className}`}>
  <div class='flex items-center gap-x-1 sm:gap-x-1.5 px-2 sm:px-3 py-1.5 bg-gray-100 border-r border-gray-200'>
    <Image src={pakFlag} alt='Pakistan' class='w-4 h-auto rounded-sm' />
    <span class='text-sm font-medium sm:text-base'>+92</span>
  </div>

  <input
    type='tel'
    name='phoneNumber'
    placeholder='Mobile number'
    class='flex-1 px-2 sm:px-3 py-1.5 text-sm sm:text-base border-none outline-none min-w-0'
    required
  />

  <button
    id='send-link-button'
    type='button'
    class='cursor-pointer bg-[#794eff] px-3 sm:px-4 py-1.5 text-white flex items-center justify-center hover:bg-[#6a3ffb] transition-colors duration-200'
    aria-label='Send download link'
  >
    <svg
      xmlns='http://www.w3.org/2000/svg'
      class='w-4 h-4 sm:w-5 sm:h-5'
      fill='none'
      viewBox='0 0 24 24'
      stroke='currentColor'
    >
      <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M14 5l7 7m0 0l-7 7m7-7H3'></path>
    </svg>
  </button>
</div>

<div
  id='toast'
  class='fixed z-50 hidden w-11/12 p-3 transition-all duration-300 transform -translate-x-1/2 translate-y-full bg-white rounded-md shadow-lg opacity-0 bottom-4 left-1/2 sm:w-auto sm:max-w-md'
>
  <div class='flex items-center'>
    <div id='toast-icon' class='flex-shrink-0 mr-2 sm:mr-3'></div>
    <div id='toast-message' class='text-sm font-medium sm:text-base'></div>
  </div>
</div>

<script define:vars={{ smsText }}>
  import axios from 'axios';

  const apiClient = axios.create({
    baseURL: 'https://sms.dovesofttech.io',
    headers: {
      'Content-type': 'application/json',
    },
  });

  function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const toastIcon = document.getElementById('toast-icon');

    if (!toast || !toastMessage || !toastIcon) return;

    toast.classList.remove('bg-green-50', 'text-green-700', 'bg-red-50', 'text-red-700');

    toastMessage.textContent = message;

    if (type === 'success') {
      toastIcon.innerHTML = `<svg class="w-5 h-5 text-green-500 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
        </svg>`;
      toast.classList.add('bg-green-50', 'text-green-700');
    } else {
      toastIcon.innerHTML = `<svg class="w-5 h-5 text-red-500 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>`;
      toast.classList.add('bg-red-50', 'text-red-700');
    }

    toast.classList.remove('hidden');
    setTimeout(() => {
      toast.classList.remove('translate-y-full', 'opacity-0');
    }, 10);

    setTimeout(() => {
      toast.classList.add('translate-y-full', 'opacity-0');
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 300);
    }, 5000);
  }

  const button = document.querySelector('#send-link-button');
  const phoneInput = document.querySelector('input[name="phoneNumber"]');

  const defaultSmsText =
    typeof smsText !== 'undefined' ? smsText : 'Download JinglePay now: https://jinglepay.com/download';

  button?.addEventListener('click', async (e) => {
    e.preventDefault();
    if (!phoneInput) return;

    const phoneNumber = phoneInput.value;
    const countryCode = '+92';

    if (phoneNumber && /^\d{10}$/.test(phoneNumber)) {
      const submitButton = document.querySelector('#send-link-button');

      try {
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.innerHTML = `<svg class="w-4 h-4 text-white sm:w-5 sm:h-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>`;
        }

        const res = await apiClient.get('/submitsms.jsp', {
          params: {
            user: 'JinglPay',
            key: 'YOUR_API_KEY',
            mobile: `${countryCode}${phoneNumber}`,
            senderid: 'JinglePay',
            message: defaultSmsText,
            accusage: '3',
          },
        });

        if (submitButton) {
          submitButton.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 sm:w-5 sm:h-5' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
            <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M14 5l7 7m0 0l-7 7m7-7H3'></path>
          </svg>`;
          submitButton.disabled = false;
        }

        if (res.data && (String(res.data).includes('success') || res.status === 200)) {
          showToast('Download link sent to your phone!', 'success');
          phoneInput.value = '';
        } else {
          console.warn('SMS API Response:', res.data); // Log unexpected responses
          showToast('Failed to send SMS. Please try again. (1)', 'error');
        }
      } catch (error) {
        console.error('Error sending SMS:', error);
        showToast('Failed to send SMS. Please try again. (2)', 'error');

        const submitButton = document.querySelector('#send-link-button');
        if (submitButton) {
          submitButton.innerHTML = `<svg xmlns='http://www.w3.org/2000/svg' class='w-4 h-4 sm:w-5 sm:h-5' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
            <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M14 5l7 7m0 0l-7 7m7-7H3'></path>
          </svg>`;
          submitButton.disabled = false;
        }
      }
    } else {
      showToast('Please enter a valid 10-digit mobile number (e.g., 3001234567)', 'error');
    }
  });
</script>
